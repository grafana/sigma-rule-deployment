name: "Sigma Rule Converter"
description: "Convert Sigma rules to target query languages using sigma-cli."
author: "Mostafa Moradian"

inputs:
  config_path:
    description: "Path to the Sigma conversion config file."
    required: true
    default: "./config.yaml"
  plugin_packages:
    description: "Comma-separated list of Sigma CLI plugin packages to install."
    required: false
    default: ""
  render_traceback:
    description: "Whether to render the traceback in the output."
    required: false
    default: "false"

runs:
  using: "composite"
  steps:
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: "3.10"

    - name: Install uv and base dependencies
      shell: bash
      run: |
        python -m pip install --upgrade pip
        pip install --disable-pip-version-check uv

    - name: Install Sigma CLI plugins (if any)
      shell: bash
      if: ${{ inputs.plugins != '' }}
      run: |
        # pySigma-backend-loki is a default plugin.
        plugin_packages="${{ inputs.plugin_packages }}"
        valid_plugins=()  # Array to store valid plugins

        shopt -s nocasematch  # Enable case-insensitive matching
        for plugin in $(echo $plugin_packages | tr ',' ' '); do
          if [[ "$plugin" == pysigma-backend-* ]]; then
            valid_plugins+=("$plugin")  # Add valid plugin to the array
          else
            echo "Error: Invalid plugin name: $plugin"
            exit 1
          fi
        done
        shopt -u nocasematch  # Disable case-insensitive matching

        # Install all valid plugins at once
        if [ ${#valid_plugins[@]} -gt 0 ]; then
          uv add --directory ${{ github.action_path }}/actions/convert "${valid_plugins[@]}"
        fi

    - name: Run Sigma rule conversion
      shell: bash
      run: |
        uv run --directory ${{ github.action_path }} actions/convert/main.py --config ${{ inputs.config_path }} --render-traceback ${{ inputs.render_traceback }}
