name: "Grafana Query Integration"
description: "Take converted rules and convert them into deployable outputs (alert rules, dashboards, etc.) and test them."
author: "security-operations"

inputs:
  config_path:
    description: "Path to the configuration file for the Sigma Rule Deployer"
    required: true
    default: ""
  grafana_sa_token:
    description: "Service account token for Grafana for query testing"
    required: false
    default: ""
  github_token:
    description: "GitHub token to use for the action."
    required: false
    default: ${{ github.token }}
  pretty_print:
    description: "Pretty print the JSON output"
    required: false
    default: "false"
  output_log_lines:
    description: "Output log lines to the outputs of the test_query_results"
    required: false
    default: "false"
  all_rules:
    description: "Whether to integrate all rules"
    required: false
    default: "false"
  changed_files:
    description: "The changed files to integrate"
    required: false
    default: ""
  deleted_files:
    description: "The deleted files to integrate"
    required: false
    default: ""

outputs:
  rules_integrated:
    description: "The repository file names changed (added/updated or removed) by this Action"
    value: ${{ steps.integrate.outputs.rules_integrated }}
  test_query_results:
    description: "The results of testing the queries against the datasource for the past hour"
    value: ${{ steps.integrate.outputs.test_query_results }}

runs:
  using: "composite"
  steps:
    # Remove checkout as unnecessary in unified workflow
    # - name: "Checkout repository (fetch-depth: 0)"
    #   id: checkout
    #   uses: actions/checkout@v4
    #   with:
    #     fetch-depth: 0 # Important to ensure we'll have all the commits when a merge includes multiple
    # - name: "Detect changed files"
    #   id: changed-files
    #   uses: step-security/changed-files@3dbe17c78367e7d60f00d78ae6781a35be47b4a1 # v45.0.1
    #   with:
    #     output_renamed_files_as_deleted_and_added: "true"
    #     sha: ${{ github.head_ref }}
    - name: Login to GitHub Container Registry
      uses: docker/login-action@v3
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ github.token }}
    - name: Run Sigma Rule Integrator
      id: integrate
      shell: bash
      env:
        CONFIG_PATH: ${{ inputs.config_path }}
        GRAFANA_SA_TOKEN: ${{ inputs.grafana_sa_token }}
        PRETTY_PRINT: ${{ inputs.pretty_print }}
        CHANGED_FILES: ${{ inputs.changed_files }}
        DELETED_FILES: ${{ inputs.deleted_files }}
        ALL_RULES: ${{ inputs.all_rules }}
        action_ref: ${{ github.action_ref }}
      run: |
        docker pull ghcr.io/grafana/sigma-rule-deployment/sigma-rule-deployer:sha-${{ env.action_ref }}
        docker run --rm -v "$(pwd):/sigma-rules" -w /sigma-rules -e INTEGRATOR_CONFIG_PATH="${CONFIG_PATH}" -e INTEGRATOR_GRAFANA_SA_TOKEN="${GRAFANA_SA_TOKEN}" -e PRETTY_PRINT="${PRETTY_PRINT}" -e CHANGED_FILES="${CHANGED_FILES}" -e DELETED_FILES="${DELETED_FILES}" -e ALL_RULES="${ALL_RULES}" ghcr.io/grafana/sigma-rule-deployment/sigma-rule-deployer:sha-${action_ref} integrate
    - name: Commit integrated queries
      uses: stefanzweifel/git-auto-commit-action@v4
