# Sigma Rule Deployer GitHub Action

**Sigma Rule Deployer** is an experimental GitHub Action that automates the deployment of Grafana alerts based on Sigma rules. This action is part of the Sigma Rule Deployment GitHub Actions Suite and is meant to be used in conjunction with the Sigma Rule Integrator, although it can work independently given the proper alert configuration files.

## Overview

The Sigma Rule Deployer action takes the alert rule files generated by the Sigma Rule Integrator and deploys them to Grafana. It supports both incremental deployments (only changed files) and fresh deployments (complete replacement). This action should be used after the Sigma Rule Integrator in your CI/CD pipeline, typically triggered by pushes to the main branch.

## Inputs

| Name               | Description                                                                                                                                                                                           | Required | Default               |
| ------------------ | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | -------- | --------------------- |
| `config_path`      | Path to the configuration file for the Sigma Rule Deployer                                                                                                                                            | Yes      | `""`                  |
| `grafana_sa_token` | Service account token for Grafana                                                                                                                                                                     | Yes      | `""`                  |
| `fresh_deploy`     | If true, ALL the alert rules in the Grafana Alert folder specified in the config will be deleted, and the alerts in the deployment folder will be created from scratch. ⚠️ Warning: destructive action | No       | `false`               |
| `github_token`     | GitHub token to use for the action.                                                                                                                                                                   | No       | `${{ github.token }}` |

Note: The token provided in `grafana_sa_token` must have the following permissions:

- Alerting: Rule Reader
- Alerting: Rule Writer
- Alerting: Access to alert rules provisioning API
- Alerting: Set provisioning status

A fresh deployment (`fresh_deploy`) will delete all existing alert rules in the Grafana Alert folder specified in the config file and then create all the alerts existing in the deployment folder. This is therefore a destructive action and should be used with caution. It is meant to be used when the alerts are to be re-deployed from scratch after a deployment drift. The advised way of using this mode is via a manually triggered workflow. Ensure a dedicated Grafana Alert folder is used for this purpose.

## Outputs

| Name             | Description                            |
| ---------------- | -------------------------------------- |
| `alerts_created` | List of alerts UIDs created in Grafana |
| `alerts_updated` | List of alerts UIDs updated in Grafana |
| `alerts_deleted` | List of alerts UIDs deleted in Grafana |

## Usage

This action is intended to be used in a workflow that is triggered by a push event to the main branch of the repository.
It is expected that the Sigma Rule Converter and Sigma Rule Integrator actions have been run in the PR that is being merged to the main branch.

This is an example of a workflow:

```yaml
name: Deploy Sigma rules

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: false

      - name: Deploy Sigma rules
        id: deploy
        uses: grafana/sigma-rule-deployment/actions/deploy@<HASH>
        with:
          config_path: ./config.yml
          grafana_sa_token: ${{ secrets.GRAFANA_SA_TOKEN }}
```

## How It Works

1. **Setup**: The action checks out the repository and prepares the environment for deployment.
2. **File Detection**: Identifies changed alert rule files using git diff to determine which files need to be deployed.
3. **Configuration Loading**: Loads and validates the deployment configuration file.
4. **Deployment Mode Selection**:
   - **Normal Mode**: Processes only changed files (added, modified, deleted)
   - **Fresh Deploy Mode**: Deletes all existing alerts in the target folder and creates all alerts from scratch
5. **Alert Processing**: For each alert rule file:
   - Parses the alert rule configuration
   - Validates the alert structure and syntax
   - Determines the target Grafana folder and rule group
6. **Grafana API Operations**:
   - **Deletions**: Removes obsolete alert rules from Grafana
   - **Updates**: Modifies existing alert rules with new configurations
   - **Creations**: Creates new alert rules in Grafana
7. **Status Reporting**:
   - Outputs lists of created, updated, and deleted alert UIDs
   - Posts deployment status comments to associated pull requests
8. **Error Handling**: Continues processing even if individual alerts fail, reporting all results

## Important Notes

### Deployment Modes

- **Normal Mode** (default): Only processes changed files, making it safe for regular deployments
- **Fresh Deploy Mode**: Completely replaces all alerts in the target folder - use with extreme caution

### Grafana Permissions

The `grafana_sa_token` must have the following permissions:

- Alerting: Rule Reader
- Alerting: Rule Writer
- Alerting: Access to alert rules provisioning API
- Alerting: Set provisioning status

### Best Practices

- Use normal mode for regular deployments triggered by pushes to main branch
- Use fresh deploy mode only for manual workflows when dealing with deployment drift
- Ensure dedicated Grafana alert folders are used for different environments
- Monitor deployment status through the generated PR comments

## Notes

This is a composite action relying on the following external actions:

- [actions/checkout v4 by GitHub](https://github.com/actions/checkout)
- [step-security/changed-files v45 by Step Security](https://github.com/step-security/changed-files)
- [docker/login-action v3 by Docker](https://github.com/docker/login-action)
- [actions/github-script v7 by GitHub](https://github.com/actions/github-script)
